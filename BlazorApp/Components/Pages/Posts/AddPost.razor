@page "/posts/add"
@using System.Security.Claims
@attribute [Authorize]

@inject IPostService PostService
@inject NavigationManager NavMgr
@inject AuthenticationStateProvider AuthProvider

<h3>Add Post</h3>

<div>
    <label>Title</label>
    <input @bind="title" />
</div>

<div>
    <label>Body</label>
    <textarea @bind="body"></textarea>
</div>

@if (!string.IsNullOrEmpty(error))
{
    <p style="color:red">@error</p>
}

<button @onclick="CreatePostAsync">Create</button>

@code {
    private string title = string.Empty;
    private string body = string.Empty;
    private string? error;

    private async Task CreatePostAsync()
    {
        error = null;

        var authState = await AuthProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (!user.Identity?.IsAuthenticated ?? true)
        {
            error = "You must be logged in to create posts.";
            return;
        }

        var idClaim = user.FindFirst(ClaimTypes.NameIdentifier);
        if (idClaim is null)
        {
            error = "No user id in claims.";
            return;
        }

        int userId = int.Parse(idClaim.Value);

        var dto = new PostCreateDto
        {
            Title = title,
            Body = body,
            UserId = userId
        };

        try
        {
            await PostService.CreateAsync(dto);
            NavMgr.NavigateTo("/posts");
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
    }
}